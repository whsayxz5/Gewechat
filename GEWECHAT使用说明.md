# Gewechat一键启动脚本使用说明

## 简介

本脚本用于快速部署和管理Gewe微信服务容器，支持单个或批量启动容器，并自动配置网络、挂载目录和端口映射。支持交互式引导菜单，无需记忆复杂命令。

## 功能特点

- 全新交互式引导菜单，操作更便捷
- 一键启动单个gewe容器，自动配置默认端口和挂载目录
- 批量启动多个gewe容器，自动创建独立的挂载目录并按顺序分配端口
- 智能识别已存在的容器，按严格顺序从gewe1开始尝试创建容器
- 自动处理容器名冲突，遇到已存在的容器名会顺序尝试下一个编号
- 端口检查功能，自动检测并避免端口冲突，确保容器正常启动
- 所有容器运行在独立的Docker网络中，便于管理和隔离
- 支持容器间通过容器名直接通信，无需使用IP地址
- 使用指定的镜像：`registry.cn-chengdu.aliyuncs.com/tu1h/wechotd:alpine`
- 彩色终端输出，操作过程直观清晰
- 容器自动设置为开机启动
- 支持容器的停止、删除和进入操作

## 使用前准备

1. 确保已安装Docker（脚本会自动检查）
2. 确保有足够权限执行Docker命令（可能需要sudo）
3. 将脚本下载到本地并添加执行权限：

```bash
chmod +x gewe_start.sh
```

## 使用方法

### 引导式菜单（推荐）

直接运行脚本，无需任何参数：

```bash
./gewe_start.sh
```

这将启动交互式菜单，提供以下选项：

| 选项 | 功能描述 |
|------|----------|
| 1 | 启动单个Gewe容器（严格按顺序尝试容器名） |
| 2 | 批量启动多个Gewe容器（严格按顺序尝试容器名） |
| 3 | 查看当前运行的容器 |
| 4 | 停止容器 |
| 5 | 删除容器 |
| 6 | 进入容器 |
| 7 | 仅拉取镜像 |
| 8 | 检查可用端口 |
| 9 | 容器网络管理 |
| 0 | 退出 |

### 命令行模式

脚本也支持以下命令行参数：

```bash
./gewe_start.sh [命令] [参数]
```

命令列表：

| 命令 | 描述 | 示例 |
|------|------|------|
| `single` | 启动单个容器（严格按顺序尝试容器名） | `./gewe_start.sh single` |
| `multi <数量>` | 批量启动多个容器（严格按顺序尝试容器名） | `./gewe_start.sh multi 3` |
| `list` | 查看所有Gewe容器 | `./gewe_start.sh list` |
| `pull` | 仅拉取并标记镜像 | `./gewe_start.sh pull` |
| `ports` | 检查可用端口 | `./gewe_start.sh ports` |
| `menu` | 启动引导式菜单 | `./gewe_start.sh menu` |
| `help` | 显示帮助信息 | `./gewe_start.sh help` |

### 使用示例

1. 启动引导式菜单：

```bash
./gewe_start.sh
```

2. 启动单个容器：

```bash
./gewe_start.sh single
```

当第一次执行时，会创建名为`gewe`的容器；如果已存在`gewe`容器，则会严格按照顺序尝试创建`gewe1`、`gewe2`等，确保按照标准的数字顺序命名。

3. 批量启动3个容器：

```bash
./gewe_start.sh multi 3
```

脚本会按严格顺序尝试创建容器，从gewe开始，然后是gewe1、gewe2等。如果某个容器名已被占用，会自动跳过并继续尝试后续的名称，确保容器名称统一规范。

4. 查看当前运行的容器：

```bash
./gewe_start.sh list
```

5. 检查系统可用端口：

```bash
./gewe_start.sh ports
```

## 功能详解

### 1. 启动单个Gewe容器
创建并启动一个新的gewe容器，按严格顺序尝试容器名称。首先尝试创建名为`gewe`的容器；如果`gewe`已存在，则按照顺序尝试`gewe1`、`gewe2`等，直到找到一个可用的名称。脚本最多会尝试20个不同的编号，确保容器名称统一规范。

### 2. 批量启动多个Gewe容器
根据用户输入的数量，批量创建并启动多个容器，按照严格的顺序尝试容器名称（gewe, gewe1, gewe2...）。对于每个容器，如果该名称已被占用，会自动跳过并尝试下一个编号，确保所有容器按照统一的命名标准创建。

### 3. 查看当前运行的容器
列出所有已创建的Gewe容器及其状态、端口映射和挂载目录等详细信息。

### 4. 停止容器
提供交互式选择，停止指定的容器。

### 5. 删除容器
提供交互式选择，删除指定的容器，会先确认以防止误操作。

### 6. 进入容器
提供交互式选择，进入指定的容器的命令行环境。进入容器后可以在容器内执行各种命令，例如查看日志、修改配置、检查网络等。完成操作后输入`exit`退出容器。

### 7. 仅拉取镜像
只拉取并标记镜像，不启动容器。

### 8. 检查可用端口
检查系统中可用的端口对，显示下一组可用的API端口和文件下载端口，帮助用户了解哪些端口可以用来启动新容器。

### 9. 容器网络管理
提供容器网络相关的功能，包括:

- **显示容器网络信息**: 查看所有容器的网络配置、IP地址等信息
- **测试容器间通信**: 验证两个容器之间是否可以通过容器名互相访问
- **添加容器到网络**: 将现有容器添加到gewe_network网络中，启用容器名通信功能

## 容器间通信功能

### 通过容器名通信
脚本创建的所有容器都连接到同一个Docker自定义网络(`gewe_network`)，这使得容器之间可以通过容器名相互通信，而不需要使用IP地址。

**主要优点**:
- 无需记忆或查找IP地址
- 即使容器重启后IP变化，通过容器名的访问依然有效
- 简化API调用，提高系统可维护性

**使用方法**:
1. 所有通过脚本创建的容器都自动连接到`gewe_network`网络
2. 在容器内部可以直接使用其他容器的名称进行访问
3. 例如，在`gewe1`容器内可以使用`http://gewe2:2531/v2/api/`访问`gewe2`容器的API

### 测试容器间通信
1. 在主菜单中选择"9. 容器网络管理"
2. 选择"2. 测试容器间通信"
3. 选择源容器和目标容器
4. 脚本会执行测试，验证源容器是否能通过容器名访问目标容器

### 手动验证容器间通信
1. 进入任意容器的命令行环境:
   ```bash
   docker exec -it gewe /bin/bash
   ```
2. 使用curl命令测试与其他容器的通信:
   ```bash
   curl http://gewe1:2531/v2/api/ -v
   ```
3. 如果返回API响应，表示通信成功

## 容器自动编号规则

```
# 单个容器启动 (single)
- 首次: 尝试使用gewe
- 如果gewe已存在: 依次尝试gewe1, gewe2, gewe3...

# 批量容器启动 (multi 3)
- 严格按顺序创建: gewe, gewe1, gewe2, ...
- 如有容器名冲突: 跳过该名称，继续尝试下一个编号
```

1. 脚本会严格按照数字顺序尝试容器名称
2. 对于单个容器启动：
   - 首先尝试不带数字的名称`gewe`
   - 如果已有`gewe`，则按顺序尝试`gewe1`、`gewe2`等
   - 按顺序尝试，直到找到一个可用的名称或达到尝试上限
3. 对于批量启动：
   - 从`gewe`开始，然后是`gewe1`、`gewe2`等，严格按数字顺序
   - 遇到已存在的容器名会自动跳过并尝试下一个编号

## 端口分配规则

对于新容器，脚本会自动查找未被占用的端口对：

1. 从基础端口(2531/2532)开始检查
2. 如果端口已被使用，则检查下一组端口(2533/2534)
3. 继续检查直到找到可用的端口对
4. 如果找不到可用端口（尝试100组后），会提示错误并中止创建

脚本使用多种方法检测端口占用：
- 检查Docker容器使用的端口
- 使用nc或lsof命令检查端口占用情况
- 使用Bash内置功能检查端口占用

## Docker启动命令

```bash
# 脚本使用的标准启动命令
docker run -itd --name=gewe --network=gewe_network -v ./gewechat/data:/root/temp -p 2531:2531 -p 2532:2532 --restart=always gewe
```

## 挂载目录

所有容器的数据都会挂载到本地目录：

- `gewe`容器：`./gewechat/data`（相对于脚本所在目录）
- `gewe1`容器：`./gewechat/data_1`
- `gewe2`容器：`./gewechat/data_2`
- 以此类推...

## 常用Docker命令

| 操作 | 命令 |
|------|------|
| 进入容器 | `docker exec -it gewe /bin/bash` |
| 查看容器日志 | `docker logs gewe` |
| 停止容器 | `docker stop gewe` |
| 删除容器 | `docker rm gewe` |
| 查看网络 | `docker network inspect gewe_network` |
| 容器间通信测试 | `docker exec -it gewe1 curl http://gewe2:2531/v2/api/` |

## 容器间通信与端口映射的区别

| 访问方式 | 访问地址示例 | 适用场景 |
|---------|------------|---------|
| 主机端口访问 | `http://192.168.1.130:2531/v2/api/` | 从宿主机或外部网络访问容器 |
| 容器名访问 | `http://gewe1:2531/v2/api/` | 在容器内部访问其他容器 |

- **主机端口访问**: 通过宿主机IP和映射的端口访问容器服务
- **容器名访问**: 仅在同一网络的容器内部使用容器名互相访问

## 注意事项

1. 确保指定的端口未被其他服务占用
2. 脚本会自动检测已使用的端口，避免端口冲突
3. 每个容器至少需要占用2个端口（API服务端口和文件下载端口）
4. 启动容器前，脚本会按严格数字顺序尝试容器名称，确保命名统一规范
5. 所有容器均设置为自动重启（--restart=always）
6. 挂载目录与容器名保持一致，例如`gewe1`对应`data_1`
7. 如果脚本无法找到可用端口，会提示错误并中止启动，您可以使用"检查可用端口"功能来诊断问题
8. 单个容器启动最多尝试20个不同的编号，如果都失败则会提示错误
9. 容器间通信仅在同一Docker网络内有效，外部网络无法通过容器名访问 